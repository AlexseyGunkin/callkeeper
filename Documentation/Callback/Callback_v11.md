# Сценарий работы Callback v.11

## Принцип работы АОНа*

АОН - автоматический определитель номера, который выводит номер звонившего и принимающего звонок. В нашем случае - клиента и менеджера. При звонке в АОН может подставляться заранее выбранный номер - это наш технический номер, который подставляется при звонке из разных локаций.

Существует деление на крупные локации (Россия, Казахстан, Европа), которые могут дробиться на более мелкие (регионы России, страны Европы и т.д.). При звонке из одной локации в другую, обе стороны видят дефолтные номера локации вместо реальных номеров.

В МА можно включить подстановку номеров и в сторону клиента, и в сторону менеджера.

Общие принципы:

-   При звонке в рамках одной локации номера АОНов совпадают с реальными номерами
    
-   При соединении номеров из разных локаций подставляются технические номера локаций
    
-   В рамках одной локации приоритет отдается кастомному Caller ID
    
-   При выборе технического номера приоритет отдается локации более низкого уровня
    
-   Если страна не относится к одной из трех локаций (Россия, Казахстан, Европа), то подставляется “ближайший” к локации номер (для ОАЭ - Германия)
    


## Алгоритм Callback v.11:

  

1.  Обращение к API VOX POST-запросом
    

Все данные по звонку формируются на нашей стороне и отправляются одним пакетом. В процессе звонка не могут изменяться.

** полный список передаваемых данных в конце документа

  

2.  Запуск сценария Callback v.11
    

  

На сервер автоматически приходит лог звонка.

Лог звонка нужен, чтобы отследить действия, произошедшие по звонку.

К логам можно обратиться в случае возникновения вопросов или ошибок - на уровне узлов, статусов звонков и т.д.

  

3.  Проверка параметра “телефон менеджера”
    

  

Существует два варианта - в запросе может быть указан один номер или несколько.

  

4.  Звонок менеджеру
    

  

1.  Если в запросе указан один номер, звонок совершается на него;
    
2.  Если в запросе указано несколько номеров, совершается либо последовательный, либо параллельный дозвон на все номера по порядку.
    

❗  Метод дозвона определяется настройкой в МА.

* Последовательный дозвон - звонок совершается на первый номер; если соединение не состоялось, перезванивает на второй; если он неуспешный, то на третий и т.д., пока не закончатся номера;
    
* Параллельный дозвон - звонок совершается одновременно на все указанные номера. После первого успешного соединения, звонок на остальные номера прерывается.
    
5.  Дозвонились
   
Если менеджер поднял трубку, включается запись разговора и проговаривается шаблонный текст.

По умолчанию текст: “Звонок с сайта. Пожалуйста, ожидайте соединения”.

❗  Проговариваемый текст можно изменить по желанию клиента через тикет.

Можно настроить свой кастомный текст для каждого инструмента.

❗  Дополнительно в виджете можно установить опцию на отмену звонка на протяжении всего звонка. Если эта опция включена, включается прослушивание **dtmf** на отмену звонка.

Отменить звонок можно только до начала соединения с клиентом.

***dtmf** - dual-tone multi-frequency - тональный набор (набор на клавиатуре телефона). Функция, взаимодействия со звонком.

Например: “Для начала звонка клиенту, нажмите кнопку “5”” - при нажатии или произнесении “5” инициируется звонок клиенту.

6.  Проговаривание присланного **IVR**
    
**IVR** - (Interactive Voice Response - "интерактивный голосовой ответ") - автоматический голосовой ответ.

Еще одна часть проговариваемого текста.

❗  Можно настроить, сколько раз информатор озвучит текст.

Если количество проговариваний меньше 16, то соединение пойдет автоматически.

По тикету можно настроить 24 проговаривания.
Если проговариваний больше 16 - соединение обрывается.

В IVR проговариваются возможности интерактивной работы со звонком, если подключен Smartcall.

**Smartcall** - интерактивный ввод команд во время звонка. Подключается и настраивается в виджете. Можно настроить, какая информация проговаривается, какие цифры используются и т.д. (например, “5” - соединение).

❗  Одна из возможных конфигураций - подключение распознавания голоса. В этом случае можно управлять звонком и при помощи тонального ввода, и голосом.

Распознавание голоса - платная услуга. Лучше его не подключать.

На этапе тестирования и первичных подключений клиентов лучше не подключать ни IVR, ни Smartcall.

Если Smartcall не подключен, то инициируется звонок клиенту (См. шаг 10)

❗  Можно настроить паузу до начала звонка в миллисекундах.

По умолчанию пауза - 3000 миллисекунд (3 секунды).

Если есть добавочные номера, которые набираются после установления соединения, можно настроить отдельно задержку перед набором добавочного номера, и перед звонком клиенту. Длительность задержки зависит от настройки атс - она может либо сразу воспринимать сигналы от клиента во время проговаривания, либо только после проговаривания текста.

Если Smartcall подключен и настроен, то менеджер прослушает заранее установленный текст.

7.  Прослушивание инструкции по работе с тональным набором (dtmf)
    
Если подключен Smartcall, озвучивается инструкция по дальнейшему взаимодействию со звонком.

❗  В МА можно назначить DTMF для:

- DTMF для SmartCall
- DTMF для проговаривания доп. информации
- DTMF для ручной отмены звонка
- DTMF для перепланирования звонка
- DTMF для отмены всех последующих реколлов


Менеджер может отменить звонок вручную при помощи соответствующей кнопки. При этом отменяется текущий звонок - кладется трубка и звонку присваивается статус 708 - “Отменен менеджером вручную”. Последующий перезвон (реколл) при этом тоже отменяется.
Если нажать кнопку после завершения звонка клиенту, то произойдет отмена последующего перезвона. 


8.  Прослушивание дополнительной информации - если она добавлена
    
Если есть дополнительная информация по звонку, ее можно прослушать, нажав установленные кнопки или проговорив цифры вслух.
Если при настройке в МА в “DTMF для проговаривания дополнительной информации” проставить #, то дополнительная информация будет проговариваться автоматически.

Дополнительную информацию определяет клиент. Она может содержать все, что захочет клиент. Берется из форм (имя клиента, модель автомобиля и т.д.) или запроса в API (добавляется вручную).

9.  Менеджер инициирует соединение с клиентом
    

❗  При подключенном Smartcall - менеджер делает это самостоятельно, проговаривая или нажимая соответствующую цифру. Перед звонком проговаривается фраза: “Звонок клиенту”.

 
Если Smartcall не подключен, соединение начинается автоматически после того, как менеджер поднимет трубку и прослушает шаблонный текст.

❗ Можно настроить задержку перед звонком в миллисекундах.  

10.  Звонок. Разговор с клиентом
   
11.  Завершение звонка - либо клиент, либо менеджер кладет трубку
    
❗  Если подключена ручная отмена звонка, после завершения звонка клиенту, менеджер может отменить последующие попытки дозвона (отмена реколлов) или запланировать новый звонок при помощи тонального набора.

❗  Чтобы запланировать новый звонок нужно нажать соответствующую кнопку - настраивается в МА.

Интервал перезвона берется из “интервалов между попытками перезвона” - настраивается в МА

См. шаг 13

12.  Если звонок не прошел (не смогли дозвониться), то идет либо перебор транков, либо завершение сценария (См. шаг 13):
    
❗  Перебор **транков** (если подключено).

**Транк** - виртуальный канал между АТС клиента и IP-оборудованием оператора, работающий по технологии IP-телефонии - связывает клиента и сервер

Перебор транков - дополнительный функционал в 11 версии. Подключается к виджету только через тикет.

По умолчанию в МА установлен один транк для всех звонков. Перебор транков подключает дополнительные транки, которые в случае неуспешного звонка по первому транку, будут использоваться по одному разу в заданном порядке.  
  

Подключенный перебор транков увеличивает шанс успешного соединения, так как неуспешный звонок не прекращается сразу, а запускает попытки соединения через другие варианты.    

Перебор всех транков обычно занимает 1,5-3 минуты.

❗  Через тикет можно настроить отдельно подстановку транков в сторону менеджера и в сторону клиента. Это может потребоваться, чтобы понять, в какую сторону чаще не проходят звонки.

  
13.  Результат по звонку
    

Сохраняется информация по звонку (длительность звонка, статус, ссылка на запись и т.д. сохраняется в базу, отображается в ЛК).

Этот шаг завершает сценарий.


### Примечание

#### Принцип работы АОНа

  

АОН - автоматический определитель номера, который выводит номер звонившего и принимающего звонок. При работе в АОН может подставляться заранее выбранный номер - это наш технический номер, который подставляется при звонке из разных локаций.

  
Весь мир разделен на локации, организованные в иерархическом порядке. Крупнейшие локации - Россия, Казахстан, Европа. Эти локации могут дробиться на более мелкие, привязанные к странам или регионам. При подстановке номера приоритет отдается локации более низкого уровня. Например, если в России звонок происходит в один из регионов, у которого есть собственный дефолтный номер, то человек, принимающий звонок, увидит подставленный номер своего региона. Справедливо и наоборот.

  
Внутри одной локации звонки происходят с реальных номеров и на реальные номера. В этом случае подстановка в АОН все равно происходит, но подставленный номер совпадает с реальными номерами.

  
Полноценные подстановки номеров происходят при звонках из одной локации в другую. В этом случае каждый номер будет заменен на соответствующий своей локации.

 
Например, если звонок идет из Казахстана в Казахстан, оба номера остаются реальными - при включенных подстановках показываются реальные номера. Если звонок идет менеджеру из России и клиенту из Казахстана, менеджер из России видит дефолтный российский номер, клиент из Казахстана видит дефолтный казахстанский номер.

За рядом стран закреплены свои дефолтные номера (Россия, Казахстан, Кипр, Германия; список может быть расширен со временем). В этом случае, если произойдет звонок “между локациями”, будут подставляться номера, соответствующие этим странам.

Если у страны нет своего дефолтного номера, подставляется номер локации более высокого порядка. Например, если звонок идет из Германии в Румынию, менеджер в Германии увидит германский номер, клиент в Румынии увидит общий технический европейский номер.

На настоящий момент у нас за всей Европой закреплен один технический германский номер. Поэтому в случае звонка из одной европейской страны в другую, обе стороны увидят технический германский номер.

Подстановка совершается автоматически до запуска сценария Callback v.11.

#### Полный список данных, передаваемых POST-запросом:

- номера менеджеров (строка. Разделители: _ и ^)
- номер клиента (строка)
- последовательный / параллельный вызов
- текст для проговаривания
- задержка перед набором добавочного
- задержка перед звонком клиенту
- текст для проговаривания
- кастомный АОН в сторону клиента
- dtmf (цифра) для запуска звонка клиенту
- транк для связи
- язык и голос (мужской/женский)
- вкл/выкл голосовое распознавание
- дополнительная информация
- dtmf для проговаривания доп информации
- ip адрес (для выбора ближайшего медиа-сервера)
- номер попытки звонка
- dtmf для автоматической передачи в сторону менеджера
- дефолтный АОН в обе стороны
- ссылка на бекенд, который принимает адрес лога звонка
- ссылка на бекенд, который принимает статус звонка
- количество проговариваний перед автоматическим соединением
- количество проговариваний перед автоматическим отключением
- dtmf для отмены звонка и последующих попыток
- текст для проговаривания, что начинаем звонить клиенту
- адрес ноды для отправки событий в течение звонка
- dtmf чтобы отложить звонок на попозже
- вкл/выкл распознавание (речь-в-текст)

[Вернуться](/README.md)
